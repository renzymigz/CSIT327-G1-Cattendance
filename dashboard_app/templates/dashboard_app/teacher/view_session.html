{% extends "dashboard_app/base_dashboard.html" %} 
{% block title %}Mark Attendance{% endblock %} 
{% block page_title %}My Session{% endblock %}
{% block content %}

<div class="p-6">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <a
      href="{% url 'dashboard_teacher:view_class' session.class_obj.id %}"
      class="text-[#a2314b] hover:underline flex items-center"
    >
      ← Back to View Class
    </a>
    
  </div>

  <div class="mb-6 bg-white p-6 rounded-xl shadow border border-gray-200">
    <div class="flex flex-col">
      <div class="flex flex-col gap-6">
        <div class="text-sm text-gray-700 flex flex-col gap-2">
          <h1 class="text-2xl font-bold text-[#6a1e1e] mb-1">
            Current Session
          </h1>
          <p class="text-base text-gray-500">
             {{session.schedule_day.day_of_week}}, {{ session.date|date:"F j, Y" }} at {{ session.schedule_day.start_time|time:"h:i A" }}
          </p>
          <div class="mt-2">
            <span class="px-3 py-1 rounded-lg border font-semibold text-sm 
              {% if session.status == 'ongoing' %}bg-yellow-100 border-amber-400 text-yellow-500
              {% elif session.status == 'completed' %}border-green-400 text-[#166534] bg-[#DCFCE7]
              {% else %}bg-gray-400{% endif %}">
              {{ session.status|capfirst }}
            </span>
          </div>
        </div>
      </div>
       <!-- Counters -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 my-5">
        <div class="rounded-xl border border-green-200 bg-green-50 p-5 text-center space-y-3">
          <p class="text-green-700 font-semibold">Present</p>
          <p id="count-present" class="text-4xl font-bold text-green-700 mt-1">0</p>
          <p class = "text-gray-500">Students marked present</p>
        </div>
        <div class="rounded-xl border border-red-200 bg-red-50 p-5 text-center space-y-3">
          <p class="text-red-700 font-semibold">Absent</p>
          <p id="count-absent" class="text-4xl font-bold text-red-700 mt-1">0</p>
          <p class = "text-gray-500">Students marked absent</p>
        </div>
        <div class="rounded-xl border border-gray-200 bg-gray-50 p-5 text-center space-y-3">
          <p class="text-gray-700 font-semibold">Not Marked</p>
          <p id="count-unmarked" class="text-4xl font-bold text-gray-700 mt-1">0</p>
          <p class = "text-gray-500">Students not yet marked</p>
        </div>
      </div>
      
      <div class="flex flex-col gap-3 sm:flex-row sm:justify-between sm:items-center w-full">
    <!-- Left group of buttons -->
    <div class="flex flex-col gap-3 sm:flex-row">
      <button
        id="btn-generate-qr"
        type="button"
        class="w-full sm:w-auto px-4 py-2 rounded-lg border font-semibold transition bg-[#a2314b] text-white border-gray-300 
        {% if session.status == 'completed' %}
          opacity-40 cursor-not-allowed border-gray-300
        {% else %}
          hover:opacity-90
        {% endif %}"
        {% if session.status == 'completed' %}disabled{% endif %}
        title="{% if session.status == 'completed' %}Session has ended{% endif %}"
      >
        <i class="fa-solid fa-qrcode mr-2"></i>Generate QR Code
      </button>

      <button
        id="btn-mark-all-present"
        type="button"
        class="w-full sm:w-auto px-4 py-2 rounded-lg border transition border-[#E2E8F0] bg-[#F8FAFC] text-gray-600
        {% if session.status == 'completed' %}
          opacity-70 cursor-not-allowed
        {% else %}
          hover:bg-gray-100
        {% endif %}"
        {% if session.status == 'completed' %}disabled{% endif %}
        title="{% if session.status == 'completed' %}Session has ended{% endif %}"
      >
        Mark All Present
      </button>

      <button
        id="btn-clear-all"
        type="button"
        class="w-full sm:w-auto px-4 py-2 rounded-lg border transition border-[#E2E8F0] bg-[#F8FAFC] text-gray-600
        {% if session.status == 'completed' %}
          opacity-70 cursor-not-allowed
        {% else %}
           hover:bg-gray-100
        {% endif %}"
        {% if session.status == 'completed' %}disabled{% endif %}
        title="{% if session.status == 'completed' %}Session has ended{% endif %}"
      >
        Clear All
      </button>
    </div>

    <!-- Export button (far right) -->

    <div class = "flex flex-col gap-3 sm:flex-row">
      <a
      href="{% url 'dashboard_teacher:export_session_attendance' class_obj.id session.id %}"
      class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 border border-[#E2E8F0] bg-[#F8FAFC] text-gray-600 rounded-md hover:bg-gray-100 transition-all"
      role="button"
    >
         <i class="fa-regular fa-download pr-2"></i>Export to CSV
      </a>
        <button 
          type="button"
          id="btn-end-session"
          class="w-full sm:w-auto px-4 py-2 rounded-lg border font-semibold transition bg-[#a2314b] text-white 
          {% if session.status == 'completed' %}
            opacity-40 cursor-not-allowed border-gray-300
          {% else %}
            hover:bg-[#8f2b43]
          {% endif %}"
          {% if session.status == 'completed' %}disabled{% endif %}
          title="{% if session.status == 'completed' %}Session already ended{% endif %}"
        >
          <i class="fa-regular fa-hourglass-end pr-2"></i>End Session 
        </button>
        
        <!-- End Session Modal -->
        <div id="endSessionModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
          <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6 text-center fade-in transition-all">
            <h2 class="text-lg font-semibold text-[#6a1e1e] mb-2">End Session</h2>
            <p class="text-gray-600 mb-4">
              Are you sure you want to end this session? All students who are not yet marked will be marked as <span class="font-semibold text-[#a2314b]">Absent</span>.
            </p>
            <form id="endSessionForm" method="POST" action="{% url 'dashboard_teacher:end_session' class_obj.id session.id %}" class="flex justify-center gap-3">
              {% csrf_token %}
              <button type="button" onclick="closeEndSessionModal()" class="px-4 py-2 border border-[#E2E8F0] bg-[#F8FAFC] text-gray-600 rounded-md hover:bg-gray-100 transition-all">
                Cancel
              </button>
              <button type="submit" class="px-4 py-2 bg-[#8f2b43] hover:bg-[#a2314b] text-white rounded-lg transition">
                End Session
              </button>
            </form>
          </div>
        </div>

    </div>
    
  </div>

    </div>
  </div>

  <!-- Session Status Notice -->
  {% if session.status == 'completed' %}
  <div class="mb-4">
    <div class="bg-blue-50 border border-blue-200 text-blue-800 px-4 py-3 rounded-lg text-sm">
      <i class="fa-solid fa-circle-info mr-2"></i>
      <strong>This session has ended.</strong> Attendance records are now read-only. You can still export the attendance data.
    </div>
  </div>
  {% endif %}

  <!-- Bulk Buttons -->
  

  {% if messages %} {% for message in messages %}
  <div
    class="my-4 p-3 text-center rounded-lg text-sm font-medium {% if message.tags == 'error' %}bg-red-100 text-red-700 border border-red-300 {% elif message.tags == 'success' %}bg-green-100 text-green-700 border border-green-300 {% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-700 border border-yellow-300 {% else %}bg-blue-100 text-blue-700 border border-blue-300{% endif %}"
  >
    {{ message }}
  </div>
  {% endfor %} {% endif %}

  <!-- Attendance Table -->

  <div id="studentsTab" class="bg-white rounded-xl shadow border border-gray-200  tab-section">
    <form method="POST">
      <div class ="flex flex-col sm:flex-row items-start sm:items-center justify-between p-5 gap-3">
        <h2 class="text-lg font-semibold text-[#6a1e1e] "><i class="fa-regular fa-calendar pr-2"></i>Student Attendance</h2>
        <button
          type="submit"
          class="w-full sm:w-auto px-5 py-2 rounded-lg font-semibold transition bg-[#a2314b] text-white 
          {% if session.status == 'completed' %}
            opacity-40  cursor-not-allowed
          {% else %}
            hover:bg-[#8f2b43]
          {% endif %}"
          {% if session.status == 'completed' %}disabled{% endif %}
          title="{% if session.status == 'completed' %}Session has ended{% endif %}"
        >
          Save Attendance
        </button>

      </div>
      <hr class = "">

      {% csrf_token %}
      <div class="overflow-x-auto rounded-2xl border-gray-200 bg-white">
        <table class="min-w-full">
          <thead class="bg-gray-50 text-left text-gray-600 font-semibold">
            <tr class="bg-[#f9fafa]">
              <th class="px-5 py-3">Student ID</th>
              <th class="px-5 py-3">Name</th>
              <th class="px-5 py-3 ">Status</th>
              <th class="px-5 py-3 ">Time</th>
              <th class="px-5 py-3 text-center">Action</th>
            </tr>
          </thead>

          <tbody id="attn-tbody" class="divide-y divide-gray-100 border-t">
            {% for a in attendances %} {% with s=a.student user=a.student.user %}
            <tr
              class="attn-row"
              data-student="{{ s.pk }} hover:bg-gray-50 transition"
            >
              <td class="px-5 text-gray-600">
                {{ s.student_id_number }}
              </td>

              <td class="p-2 font-medium text-gray-800">
                <div class = "flex flex-col">
                  <span>{{ user.first_name }} {{ user.last_name }}</span>
                  <span class="text-sm text-gray-500">{{ user.email }}</span>
              </td>

              <!-- STATUS column -->
              <td class="p-2 font-semibold">
                <div id="display-status-{{ s.pk }}">
                  {% if a.is_present is True %}
                  <span class="text-green-700 px-3 py-1 font-medium bg-green-50  border border-green-500 rounded-lg">Present {% if a.marked_via_qr %}
                  <i
                    class="fa-solid fa-qrcode text-green-600 ml-1"
                    title="Marked via QR"
                  ></i>
                  {% endif %}</span>
                  {% elif a.is_present is False %}
                  <span class="text-red-700 px-3 py-1 font-medium bg-red-50 border border-red-500 rounded-lg">Absent</span>
                  {% else %}
                  <span class="text-gray-500 px-3 py-1 bg-[#F8FAFC] border border-[#BEC6D0] rounded-lg">Not Marked</span>
                  {% endif %}
                </div>

                <input
                  type="hidden"
                  id="status-{{ s.pk }}"
                  name="status_{{ s.pk }}"
                  value="{% if a.is_present is True %}present{% elif a.is_present is False %}absent{% else %}{% endif %}"
                />
              </td>

              <td class="p-2 ">
                {% if a.timestamp %}
                  {{ a.timestamp|time:"h:i A" }}
                {% else %}
                  —
                {% endif %}
              </td>
              
              <!-- ACTION buttons -->
              <td class="p-2 text-center">
                <div class="inline-flex gap-2">
                  <button
                    type="button"
                    class="btn-present flex items-center justify-center w-10 h-10 rounded-md transition bg-[#F8FAFC] border border-[#E2E8F0] text-gray-600
                    {% if session.status == 'completed' %}
                      opacity-50 cursor-not-allowed border border-gray-300
                    {% else %}
                      hover:bg-gray-100
                    {% endif %}"
                    {% if session.status == 'completed' %}disabled{% endif %}
                  >
                    <i class="fa-regular fa-circle-check"></i>
                  </button>
                  <button
                    type="button"
                    class="btn-absent flex items-center justify-center w-10 h-10 rounded-md transition bg-[#F8FAFC] border border-[#E2E8F0] text-gray-600
                    {% if session.status == 'completed' %}
                      opacity-50 cursor-not-allowed border border-gray-300
                    {% else %}
                       hover:bg-gray-100
                    {% endif %}"
                    {% if session.status == 'completed' %}disabled{% endif %}
                  >
                    <i class="fa-regular fa-circle-xmark"></i>
                  </button>
                </div>
              </td>

              
            </tr>
            {% endwith %} {% empty %}
            <tr>
              <td colspan="4" class="px-5 py-6 text-gray-600 text-center">
                No students enrolled.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>


      <div
        id="qr-modal"
        class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50"
      >
        <div
          class="bg-white rounded-2xl p-5 min-w-[300px] sm:min-w-[550px] max-w-2xl relative shadow-xl"
        >
          <button
            id="close-qr-modal"
            type="button"
            class="absolute top-3 right-4 border border-gray-300 rounded w-8 text-gray-500 hover:text-gray-700 text-lg"
          >
            <i class="fa-solid fa-xmark"></i>
          </button>

          <h2 class="text-lg font-semibold mb-3">Session QR Code</h2>
          <p class="text-gray-600 text-sm">
            Students can scan this QR code to mark attendance.
          </p>

          <div id="qr-container" class="flex justify-center">
            <!-- QR render -->
            <img
              id="qr-image"
              alt="Session QR Code"
              class="w-[300px] h-[300px] sm:w-[500px] sm:h-[500px] p-2 my-8 rounded-lg object-contain"
            />
          </div>

          <p class="text-gray-600 text-lg mb-1 text-center font-semibold">
            Time Remaining
          </p>

          <p
            id="qr-timer"
            class="font-bold font-mono text-[#a2314b] text-center text-2xl"
          >
            05:00
          </p>

          <p class="text-gray-600 text-sm text-center mb-5">
            Will automatically regenerate when expired
          </p>
          <div class="flex justify-center mt-2">
            <button id="btn-end-qr" type="button" class="px-4 py-2 rounded-lg border border-red-300 text-red-600 bg-white hover:bg-red-50 hidden">
              <i class="fa-regular fa-xmark mr-2"></i>End QR
            </button>
          </div>
        </div>
      </div>

      <!-- QR Options Modal -->
      <div id="qrOptionsModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6 text-center fade-in transition-all">
          <h2 class="text-lg font-semibold text-[#6a1e1e] mb-2">Generate QR Code</h2>
          <p class="text-gray-600 mb-4">Choose how long the QR code should remain active:</p>

          <form id="qrOptionsForm" class="space-y-3">
            <div class="flex flex-col text-left">
              <label class="inline-flex items-center"><input type="radio" name="qr_minutes" value="5" checked class="mr-2">5 minutes</label>
              <label class="inline-flex items-center"><input type="radio" name="qr_minutes" value="10" class="mr-2">10 minutes</label>
              <label class="inline-flex items-center"><input type="radio" name="qr_minutes" value="15" class="mr-2">15 minutes</label>
              <label class="inline-flex items-center"><input type="radio" name="qr_minutes" value="30" class="mr-2">30 minutes</label>
              <label class="inline-flex items-center"><input type="radio" name="qr_minutes" value="60" class="mr-2">60 minutes</label>
              <label class="inline-flex items-center"><input type="radio" name="qr_minutes" value="custom" class="mr-2">Custom (minutes)</label>
              <input type="number" id="qrCustomMinutes" min="1" placeholder="Enter minutes" class="mt-2 p-2 border rounded w-full" disabled />
            </div>

            <div class="flex justify-center gap-3 mt-4">
              <button type="button" id="qrOptionsCancel" class="px-4 py-2 border border-[#E2E8F0] bg-[#F8FAFC] text-gray-600 rounded-md hover:bg-gray-100">Cancel <i class="fa-solid fa-arrow-turn-down-left pl-1"></i></button>
              <button type="button" id="qrOptionsGenerate" class="px-4 py-2 bg-[#8f2b43] hover:bg-[#a2314b] text-white rounded-lg">Generate QR <i class="fa-solid fa-qrcode pl-1"></i></button>
            </div>
          </form>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Script -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const tbody = document.getElementById("attn-tbody");
    const base = ["bg-[#F8FAFC]", "text-gray-600", "border-[#E2E8F0]"];
    const present = ["bg-green-50", "text-green-700", "border-green-500"];
    const absent = ["bg-red-50", "text-red-700", "border-red-500"];
    const qrBtn = document.getElementById("btn-generate-qr");
    const qrModal = document.getElementById("qr-modal");
    const qrClose = document.getElementById("close-qr-modal");
    const qrImage = document.getElementById("qr-image");
    const qrTimer = document.getElementById("qr-timer");

    // Check if session is completed
    const isCompleted = "{{ session.status|lower }}" === "completed";
    // Server-provided initial QR active flag (mutable client-side state)
    let qrIsActive = {{ qr_active|yesno:"true,false" }};

    let qrInterval = null;

    if (qrIsActive) {
      if (qrModal) qrModal.classList.remove('hidden');
      fetchAndShowQR();
    }

    async function fetchAndShowQR(minutes = 5) {
      // Call server to generate QR
      try {
        const body = new URLSearchParams();
        body.append('minutes', String(minutes));

        const resp = await fetch(window.location.pathname + "generate-qr/", {
          method: "POST",
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
          },
          body: body,
        });
        if (!resp.ok) throw new Error("Failed to generate QR");
        const data = await resp.json();

        // set image
        if (data.qr_image) {
          qrImage.src = data.qr_image;
        } else {
          // fallback: show scan_url as text if no image
          qrImage.alt = data.scan_url;
        }

        // mark active on client and start countdown
        qrIsActive = true;
        const expiresAt = new Date(data.expires_at);
        startCountdown(expiresAt);
      } catch (err) {
        console.error(err);
        alert("Failed to generate QR code.");
      }
    }

    if (qrBtn && !isCompleted) {
      qrBtn.addEventListener("click", () => {
        // If server reports QR already active, open QR modal instead of options
        if (qrIsActive || !qrModal.classList.contains('hidden') || qrInterval) {
          qrModal.classList.remove('hidden');
          // If there is no active timer/image loaded, fetch the active QR now
          if (!qrInterval) fetchAndShowQR();
          return;
        }
        // open options modal
        const opts = document.getElementById('qrOptionsModal');
        if (opts) opts.classList.remove('hidden');
      });
    }

    if (qrClose) {
      qrClose.addEventListener("click", () => {
        qrModal.classList.add("hidden");
        if (qrInterval) {
          clearInterval(qrInterval);
          qrInterval = null;
        }
        const endQrBtn = document.getElementById('btn-end-qr');
        if (endQrBtn) endQrBtn.classList.add('hidden');
      });
    }

    if (qrModal) {
      qrModal.addEventListener("click", (e) => {
        if (e.target === qrModal) {
          qrModal.classList.add("hidden");
          if (qrInterval) {
            clearInterval(qrInterval);
            qrInterval = null;
          }
          const endQrBtn = document.getElementById('btn-end-qr');
          if (endQrBtn) endQrBtn.classList.add('hidden');
        }
      });
    }

    function startCountdown(expiresAt) {
      if (qrInterval) clearInterval(qrInterval);
      function update() {
        const now = new Date();
        let diff = Math.max(0, Math.floor((expiresAt - now) / 1000));
        const minutes = String(Math.floor(diff / 60)).padStart(2, "0");
        const seconds = String(diff % 60).padStart(2, "0");
        qrTimer.textContent = `${minutes}:${seconds}`;
        if (diff <= 0) {
          clearInterval(qrInterval);
          qrInterval = null;
          // automatically regenerate after expiry
          fetchAndShowQR();
        }
      }
      update();
      qrInterval = setInterval(update, 1000);
      // show End QR button when active
      const endQrBtn = document.getElementById('btn-end-qr');
      if (endQrBtn) endQrBtn.classList.remove('hidden');
    }

    // End QR action
    async function endActiveQR(){
      try{
        const resp = await fetch('{% url "dashboard_teacher:end_qr" class_obj.id session.id %}', {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          }
        });
        const data = await resp.json();
        if(resp.ok && data.ok){
          if(qrInterval){ clearInterval(qrInterval); qrInterval = null; }
          // clear client-side active flag so reopening shows options modal
          qrIsActive = false;
          // hide qr modal and end button
          qrModal.classList.add('hidden');
          const endQrBtn = document.getElementById('btn-end-qr');
          if (endQrBtn) endQrBtn.classList.add('hidden');
          // clear image and reset timer display
          qrImage.src = '';
          qrTimer.textContent = '00:00';
          alert('QR ended.');
        } else {
          alert(data.message || 'Failed to end QR');
        }
      }catch(err){
        console.error(err);
        alert('Failed to end QR');
      }
    }

    // wire end QR button
    const endQrBtn = document.getElementById('btn-end-qr');
    if(endQrBtn){ endQrBtn.addEventListener('click', ()=>{ if(confirm('End active QR now?')) endActiveQR(); }); }

    // QR Options modal handlers
    const qrOptionsModal = document.getElementById('qrOptionsModal');
    const qrOptionsCancel = document.getElementById('qrOptionsCancel');
    const qrOptionsGenerate = document.getElementById('qrOptionsGenerate');
    const qrCustomMinutes = document.getElementById('qrCustomMinutes');

    if(qrOptionsModal){
      // enable/disable custom input depending on selected radio
      qrOptionsModal.addEventListener('change', (e)=>{
        const target = e.target;
        if(target.name === 'qr_minutes'){
          const custom = qrOptionsModal.querySelector('input[name="qr_minutes"][value="custom"]');
          if(custom && custom.checked){ qrCustomMinutes.disabled = false; qrCustomMinutes.focus(); }
          else { qrCustomMinutes.disabled = true; qrCustomMinutes.value = ''; }
        }
      });

      if(qrOptionsCancel) qrOptionsCancel.addEventListener('click', ()=>{ qrOptionsModal.classList.add('hidden'); });

      if(qrOptionsGenerate) qrOptionsGenerate.addEventListener('click', ()=>{
        // determine minutes
        const chosen = qrOptionsModal.querySelector('input[name="qr_minutes"]:checked');
        if(!chosen){ alert('Please choose a duration.'); return; }
        let minutes = chosen.value;
        if(minutes === 'custom'){
          const v = parseInt(qrCustomMinutes.value, 10);
          if(!v || v <= 0){ alert('Please enter a valid number of minutes.'); return; }
          minutes = v;
        } else {
          minutes = parseInt(minutes, 10);
        }

        // close options and open QR modal
        qrOptionsModal.classList.add('hidden');
        qrModal.classList.remove('hidden');
        // generate QR with specified minutes
        fetchAndShowQR(minutes);
      });
    }

    function paintRow(row, value) {
      const btnP = row.querySelector(".btn-present");
      const btnA = row.querySelector(".btn-absent");
      
      // Don't paint if session is completed
      if (isCompleted) return;
      
      [btnP, btnA].forEach((b) => {
        b.classList.remove(...present, ...absent);
        b.classList.add(...base);
      });
      if (value === "present") {
        btnP.classList.remove(...base);
        btnP.classList.add(...present);
      } else if (value === "absent") {
        btnA.classList.remove(...base);
        btnA.classList.add(...absent);
      }
    }

    function setRowState(row, value) {
      if (isCompleted) return; // Prevent changes if completed
      
      const input = row.querySelector("input[type='hidden']");
      input.value = value;
      paintRow(row, value);
    }

    function recompute() {
      let p = 0,
        a = 0,
        n = 0;
      document.querySelectorAll("tbody input[type='hidden']").forEach((inp) => {
        if (inp.value === "present") p++;
        else if (inp.value === "absent") a++;
        else n++;
      });
      document.getElementById("count-present").textContent = p;
      document.getElementById("count-absent").textContent = a;
      document.getElementById("count-unmarked").textContent = n;
    }

    tbody.addEventListener("click", (e) => {
      if (isCompleted) return; // Prevent clicks if completed
      
      const btn = e.target.closest(".btn-present, .btn-absent");
      if (!btn) return;
      const row = btn.closest("tr.attn-row");
      const input = row.querySelector("input[type='hidden']");
      const newVal = btn.classList.contains("btn-present")
        ? "present"
        : "absent";
      setRowState(row, input.value === newVal ? "" : newVal);
      recompute();
    });

    const markAllBtn = document.getElementById("btn-mark-all-present");
    if (markAllBtn && !isCompleted) {
      markAllBtn.addEventListener("click", () => {
        document
          .querySelectorAll("tr.attn-row")
          .forEach((r) => setRowState(r, "present"));
        recompute();
      });
    }

    const clearAllBtn = document.getElementById("btn-clear-all");
    if (clearAllBtn && !isCompleted) {
      clearAllBtn.addEventListener("click", () => {
        document
          .querySelectorAll("tr.attn-row")
          .forEach((r) => setRowState(r, ""));
        recompute();
      });
    }

    document.querySelectorAll("tr.attn-row").forEach((r) => {
      const val = r.querySelector("input[type='hidden']").value || "";
      paintRow(r, val);
    });
    recompute();

    // End Session modal handlers
    const endBtn = document.getElementById('btn-end-session');
    const endModal = document.getElementById('endSessionModal');
    function openEndSessionModal(){
      if(endModal){ endModal.classList.remove('hidden'); endModal.classList.add('flex'); }
    }
    function closeEndSessionModal(){
      if(endModal){ endModal.classList.add('hidden'); endModal.classList.remove('flex'); }
    }
    if(endBtn){
      endBtn.addEventListener('click', (e)=>{
        // only open modal if button is not disabled
        if(!endBtn.disabled) openEndSessionModal();
      });
    }
    // expose close to global for inline onclick on Cancel
    window.closeEndSessionModal = closeEndSessionModal;
  });
</script>

{% endblock %}