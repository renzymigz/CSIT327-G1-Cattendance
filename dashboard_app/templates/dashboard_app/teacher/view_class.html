{% extends "dashboard_app/base_dashboard.html" %} 
{% block title %}View Class | Cattendance{% endblock %} 

{% block content %}
<div class="p-6">
  <!-- Header -->
  <div class="mb-6">
    <h1 class="text-2xl font-bold text-[#6a1e1e] mb-1">
      {{ class_obj.title }} ({{ class_obj.code }})
    </h1>
    <p class="text-sm text-gray-600 mb-2">
      Section {{ class_obj.section }} | {{ class_obj.semester }} |
      {{class_obj.academic_year }}
    </p>

    {% if class_obj.schedules.exists %}
    <div class="mt-3 bg-gray-50 p-3 rounded-lg border border-gray-200 w-fit">
      <h2 class="text-sm font-semibold text-gray-700 mb-1">Class Schedule</h2>
      <ul class="list-disc list-inside text-sm text-gray-600">
        {% for sched in class_obj.schedules.all %}
        <li>
          {{ sched.day_of_week }} — {{ sched.start_time|time:"h:i A" }} to {{sched.end_time|time:"h:i A" }}
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
  </div>
  
  <div class="my-6">
    <a
      href="{% url 'dashboard_teacher:manage_classes' %}"
      class="text-[#a2314b] hover:underline"
    >
      ← Back to Manage Classes
    </a>
  </div>


  <!-- Add Student Section -->
  <div class="mb-8 bg-white p-5 rounded-xl shadow border border-gray-200">
    <h2 class="text-lg font-semibold text-[#6a1e1e] mb-3">Add Student</h2>
    <form method="POST" class="flex flex-col sm:flex-row gap-3">
      {% csrf_token %}
      <input type="hidden" name="add_student" value="1" />
      <input
        type="email"
        name="student_email"
        class="flex-grow bg-[#f6f7f8] border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#a2314b]"
        placeholder="Enter student email"
        required
      />
      <button
        type="submit"
        class="bg-[#a2314b] hover:bg-[#8f2b43] text-white px-5 py-2 rounded-lg shadow-md transition"
      >
        Add
      </button>
    </form>
  </div>

    {% if messages %} {% for message in messages %}
<div
  class="my-4 p-3 text-center items-center rounded-lg text-sm font-medium {% if message.tags == 'error' %}bg-red-100 text-red-700 border border-red-300{% elif message.tags == 'success' %}bg-green-100 text-green-700 border border-green-300{% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-700 border border-yellow-300{% else %}bg-blue-100 text-blue-700 border border-blue-300{% endif %}"
>
  {{ message }}
</div>
{% endfor %} {% endif %}

  <!-- Student List -->
  <div class="bg-white p-5 rounded-xl shadow border border-gray-200 mb-8">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg font-semibold text-[#6a1e1e] mb-3">Enrolled Students</h2>
  
  <!-- Export button (far right) -->
      <a
         href="{% url 'dashboard_teacher:export_enrolled_students_csv' class_obj.id %}"
        class="inline-flex items-center px-4 py-2 bg-[#a2314b] hover:bg-[#8f2b43] text-white text-sm rounded-md shadow"
        role="button">
        Export to CSV
      </a>
    </div>
  </div>

    {% if enrollments %}
    <div class="overflow-x-auto">
      <table
        class="min-w-full border border-gray-200 rounded-lg overflow-hidden"
      >
        <thead class="bg-gray-100">
          <tr>
            <th class="text-left p-2">#</th>
            <th class="text-left p-2">Student</th>
            <th class="text-left p-2">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for enrollment in enrollments %}
          <tr class="border-t hover:bg-gray-50 transition">
            <td class="p-2">{{ forloop.counter }}</td>
            <td class="p-2">
              <span class="font-medium"
                >{{ enrollment.student.user.get_full_name }}</span
              ><br />
              <span class="text-xs text-gray-500"
                >{{ enrollment.student.user.email }}</span
              >
            </td>
            <td class="p-2">
              <button
                type="submit"
                class="bg-[#a2314b] hover:bg-[#88263d] text-white px-3 py-1 rounded transition"
                onclick="openRemoveModal('{{ enrollment.id }}', '{{ enrollment.student.user.email }}')"
              >
                Remove
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-gray-500">No students enrolled yet.</p>
    {% endif %}
  </div>

  <div class="bg-white p-5 rounded-xl shadow border border-gray-200">
    <h2 class="text-lg font-semibold text-[#6a1e1e] mb-3">Class Sessions</h2>

    <!-- Create Session Form -->
    <form method="POST" class="flex flex-col sm:flex-row gap-3 mb-5">
      {% csrf_token %} {{ session_form.as_p }}
      <button
        type="submit"
        name="create_session"
        class="bg-[#a2314b] hover:bg-[#8f2b43] text-white px-5 py-2 rounded-lg shadow-md transition self-start"
      >
        Create Session
      </button>
    </form>

    <!-- List of Sessions -->
    {% if sessions %}
    <div class="overflow-x-auto">
      <table
        class="min-w-full border border-gray-200 rounded-lg overflow-hidden"
      >
        <thead class="bg-gray-100">
          <tr>
            <th class="text-left p-2">Date</th>
            <th class="text-left p-2">Schedule</th>
            <th class="text-left p-2">Status</th>
          </tr>
        </thead>
        <tbody>
          {% for session in sessions %}
          <tr class="border-t hover:bg-gray-50 transition">
            <td class="p-2">{{ session.date|date:"M d, Y" }}</td>
            <td class="p-2">
              {{ session.schedule_day.day_of_week }} — {{ session.schedule_day.start_time|time:"h:i A" }} to {{session.schedule_day.end_time|time:"h:i A" }}
            </td>
            <td class="p-2">
              <span
                class="px-2 py-1 rounded text-white text-sm {% if session.status == 'ongoing' %}bg-yellow-500 {% elif session.status == 'completed' %}bg-green-600 {% else %}bg-gray-400{% endif %}"
              >
                {{ session.status|capfirst }}
              </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-gray-500">No sessions yet.</p>
    {% endif %}
  </div>

  

  <div
    id="removeModal"
    class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50"
  >
    <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6 text-center">
      <h2 class="text-lg font-semibold text-[#6a1e1e] mb-2">Confirm Removal</h2>
      <p class="text-gray-600 mb-4">
        Are you sure you want to remove
        <span id="studentEmail" class="font-medium text-[#a2314b]"></span> from
        this class?
      </p>
      <form id="removeForm" method="POST" class="flex justify-center gap-3">
        {% csrf_token %}
        <input type="hidden" name="remove_student" id="removeStudentId" />
        <button
          type="button"
          onclick="closeRemoveModal()"
          class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded-lg transition"
        >
          Cancel
        </button>
        <button
          type="submit"
          class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition"
        >
          Remove
        </button>
      </form>
    </div>
  </div>

  <script>
    function openRemoveModal(studentId, studentEmail) {
      document.getElementById("studentEmail").textContent = studentEmail;
      document.getElementById("removeStudentId").value = studentId;
      document.getElementById("removeModal").classList.remove("hidden");
      document.getElementById("removeModal").classList.add("flex");
    }

    function closeRemoveModal() {
      document.getElementById("removeModal").classList.add("hidden");
      document.getElementById("removeModal").classList.remove("flex");
    }
  </script>

  {% endblock %}
</div>
