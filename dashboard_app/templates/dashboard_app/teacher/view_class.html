{% extends "dashboard_app/base_dashboard.html" %}
{% block title %}View Class | Cattendance{% endblock %} 

{% block content %}
<div class="p-6">
  <!-- Header -->
  <div class="mb-6">
    <a href="{% url 'dashboard_teacher:manage_classes' %}" class="text-[#a2314b] hover:underline">
      ← Back to Manage Classes
    </a>
  </div>

  <div class="mb-6 bg-white p-6 rounded-xl shadow border border-gray-200">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      
      <div class = "flex flex-col gap-6">
      <div class = "text-sm text-gray-700 flex flex-col gap-2">
        <div>
          <i class="fa-solid fa-code pr-2"></i>COURSE CODE
        </div>
        <h1 class="text-2xl font-bold text-[#6a1e1e] mb-1">
          {{ class_obj.code }}
        </h1>
      </div>
      <div class = "text-sm text-gray-700 flex flex-col gap-2">
        <div>
          <i class="fa-regular fa-book pr-2"></i>COURSE TITLE
        </div>
        <h1 class="text-2xl font-bold text-[#6a1e1e] mb-1">
          {{ class_obj.title }} 
        </h1>
      </div>
      
      <div class = "text-sm text-gray-700 flex flex-col gap-2">
        <div>
          <i class="fa-regular fa-tag pr-2"></i>SECTION
        </div>
        <h1 class="text-2xl font-bold text-[#6a1e1e] mb-1">
          {{ class_obj.section }}
        </h1>
      </div>
      </div>

      <div class = "flex flex-col gap-6">
      <div class = "text-sm text-gray-700 flex flex-col gap-2">
        <div>
          <i class="fa-solid fa-timer pr-2"></i>SEMESTER & ACADEMIC YEAR
        </div>
        <h1 class="text-2xl font-bold text-[#6a1e1e] mb-1">
          {{ class_obj.semester }} Semester {{ class_obj.academic_year }}
        </h1>
      </div>

      {% if class_obj.schedules.exists %}
      <div class="text-sm text-gray-700 flex flex-col gap-2">
        <h2 class="mb-1"><i class="fa-regular fa-calendar pr-2"></i>CLASS SCHEDULE</h2>
        <ul class=" list-inside text-gray-600 text-base bg-[#F8FAFC] w-fit py-1 px-4 rounded-lg">
          {% for sched in class_obj.schedules.all %}
          <li>
            <span class = "font-semibold">{{ sched.day_of_week }}</span>— {{ sched.start_time|time:"h:i A" }} - {{ sched.end_time|time:"h:i A" }}
          </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </div>
    </div>
  </div>

  <div class = "flex flex-col md:flex-row md:space-x-4 space-y-6 md:space-y-0 mb-4">
    <button id="studentsTabBtn" class = "w-full md:w-auto bg-[#8f2b43] text-white px-5 py-2 rounded-md shadow-md transition ">
        <i class="fa-regular fa-user-group pr-2"></i>Enrolled Students
    </button>
    <button id="sessionsTabBtn" class = "w-full md:w-auto border border-gray-400 bg-[#F8FAFC] text-gray-600 px-5 py-2 rounded-md transition ">
        <i class="fa-regular fa-calendar pr-2"></i>Class Sessions 
    </button>
  </div>
  <!-- Add Student Section -->

  {% if messages %}
    {% for message in messages %}
      <div
        class="my-4 p-3 text-center rounded-lg text-sm font-medium
        {% if message.tags == 'error' %}bg-red-100 text-red-700 border border-red-300
        {% elif message.tags == 'success' %}bg-green-100 text-green-700 border border-green-300
        {% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-700 border border-yellow-300
        {% else %}bg-blue-100 text-blue-700 border border-blue-300{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <!-- Enrolled Students -->
  <div id="studentsTab" class="bg-white rounded-xl shadow border border-gray-200 mb-8 tab-section">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between p-5 text-center sm:text-left gap-4">

  <!-- Title -->
  <h2 class="text-lg font-semibold text-[#6a1e1e] flex justify-center sm:justify-start items-center">
    <i class="fa-regular fa-user-group pr-2"></i>Enrolled Students
  </h2>

  <!-- Buttons -->
  <div class="flex flex-col sm:flex-row gap-3 text-base sm:text-right">
      
    <a
      href="{% url 'dashboard_teacher:export_enrolled_students_csv' class_obj.id %}"
      role="button"
      class="border px-4 py-2 border-[#E2E8F0] bg-[#F8FAFC] text-gray-600 rounded-md hover:bg-gray-100 transition-all w-full sm:w-auto"
    >
      <i class="fa-regular fa-download mr-2"></i>Export to CSV
    </a>

    <button
      id="addStudentBtn"
      class="inline-flex items-center px-5 py-2 bg-[#a2314b] hover:bg-[#8f2b43] text-white rounded-md shadow w-full sm:w-auto justify-center"
    >
      <i class="fa-solid fa-plus mr-2"></i>Add Student
    </button>

    <button
      id="uploadCsvBtn"
      class="inline-flex items-center px-5 py-2 bg-[#a2314b] hover:bg-[#8f2b43] text-white rounded-md shadow w-full sm:w-auto justify-center"
    >
      <i class="fa-solid fa-upload mr-2"></i>Upload CSV
    </button>

  </div>
</div>


    <hr class = "">

    <div class="p-6 space-y-4 border-b border-gray-200 transition-all duration-300 hidden f" id="addStudentSection">
      <h1 class="text-base font-semibold">Enroll New Student</h1>

      <form method="POST" class="flex flex-col sm:flex-row gap-3">
        {% csrf_token %}
        <input type="hidden" name="add_student" value="1" />

        <input
          type="email"
          name="student_email"
          class="flex-grow bg-[#f6f7f8] border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-[#a2314b]"
          placeholder="Enter student email"
          required
        />

        <div class="flex flex-col sm:flex-row gap-3">
          <button
            type="submit"
            class="bg-[#a2314b] hover:bg-[#8f2b43] text-white px-5 py-2 rounded-lg shadow-md transition"
          >
            Add
          </button>

          <button
            type="button"
            class="bg-[#F8FAFC] cancel-btn border border-[#E2E8F0] px-5 py-2 rounded-lg transition"
          >
            Cancel
          </button>
        </div>
      </form>
    </div>


    <div
  id="uploadCsvSection"
  class="p-6 space-y-4 border-b border-gray-200 transition-all duration-300 hidden"
>
  <h1 class="text-base font-semibold">Add Students via CSV</h1>

  <p class="text-sm text-gray-600">
    CSV format: any columns, emails extracted from cells containing '@'
  </p>

  <form
    method="POST"
    enctype="multipart/form-data"
    action="{% url 'dashboard_teacher:upload_students_csv' class_obj.id %}"
  >
    {% csrf_token %}

    <!-- FLEX wrapper for input + buttons -->
    <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center justify-between">
      <!-- File input -->
      <input
        type="file"
        name="csv_file"
        accept=".csv"
        class="bg-[#f6f7f8] border-gray-300 border text-gray-600 px-3 py-2 rounded-md w-full sm:w-auto"
        required
      />

      <!-- Buttons wrapper -->
      <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
        <button
          type="submit"
          name="upload_csv"
          class="px-5 py-2 bg-[#a2314b] hover:bg-[#8f2b43] text-white rounded-md transition w-full sm:w-auto"
        >
          Upload CSV
        </button>

        <button
          type="button"
          class="csv-cancel-btn px-5 py-2 bg-[#F8FAFC] border border-[#E2E8F0] rounded-md hover:bg-gray-100 transition w-full sm:w-auto"
        >
          Cancel
        </button>
      </div>
    </div>
  </form>
</div>



    {% if enrollments %}
    <div class="overflow-x-auto">
      <table class="min-w-full border border-gray-200 rounded-lg overflow-hidden">
        <thead class="bg-[#f9fafa]">
          <tr class = "text-gray-700">
            <th class="text-left px-5 p-2 font-semibold">Student ID</th>
            <th class="text-left p-2 font-semibold">Name</th>
            <th class="text-left p-2 font-semibold">Email</th>
            <th class="text-left p-2 font-semibold">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for enrollment in enrollments %}
          <tr class="border-t hover:bg-gray-50 transition">
            <td class="px-5 p-2">{{ enrollment.student.student_id_number }}</td>
            <td class="p-2">
             {{ enrollment.student.user.first_name }} {{ enrollment.student.user.last_name }}
            </td>
            <td class="p-2"><i class="fa-light fa-envelope pr-2"></i>{{ enrollment.student.user.email }}</td>
            <td class="p-2">
              <button
                type="button"
                class="bg-[#F8FAFC] border border-[#E2E8F0] hover:bg-[#fee2e3] hover:text-[#c10006] hover:border-[#c100064b] px-2 py-1 rounded transition"
                onclick="openRemoveModal(
                        '{{ enrollment.id }}',
                        '{{ enrollment.student.user.first_name }} {{ enrollment.student.user.last_name }}'
                    )">
                <i class="fa-regular fa-trash-can"></i>
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-gray-500 p-5 text-center">No students enrolled yet.</p>
    {% endif %}
  </div>


  <!-- Class Sessions -->
  <div id = "sessionsTab" class="bg-white rounded-xl shadow border border-gray-200 tab-section hidden">

    <div class ="flex items-center justify-between p-5">
      <h2 class="text-lg font-semibold text-[#6a1e1e] "><i class="fa-regular fa-calendar pr-2"></i>Class Sessions</h2>

      <!-- Create Session Form -->
      <form method="POST" action="{% url 'dashboard_teacher:create_session' class_obj.id %}" class="flex flex-col sm:flex-row gap-3  text-center items-center justify-center">
        {% csrf_token %}
        <span class = "bg-[#F8FAFC] border border-[#E2E8F0] text-gray-600 px-4 py-2 rounded-md">
          {{ session_form.as_p }}
        </span>
        <button
          type="submit"
          id="createSessionBtn"
          class="px-5 py-2 rounded-md shadow transition self-start bg-[#a2314b] text-white
          {% if can_create_session %}
            hover:bg-[#8f2b43]
          {% else %}
            opacity-40 cursor-not-allowed
          {% endif %}"
          {% if not can_create_session %}disabled{% endif %}
          title="{% if not can_create_session %}Session can only be created during scheduled class time ({{ current_day }}, {{ current_time|time:'h:i A' }}){% endif %}">
          <i class="fa-solid fa-calendar-circle-plus pr-2"></i>Create Session
        </button>
      </form>

      </div>
    <!-- Schedule Notice -->
    {% if not can_create_session %}
    <div class="px-5 pb-3">
      <div class="bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-3 rounded-lg text-sm">
        <i class="fa-solid fa-circle-info mr-2"></i>
        <strong>Note:</strong> You can only create a session during scheduled class time. 
        Current: <strong>{{ current_day }}, {{ current_time|time:"h:i A" }}</strong>
      </div>
    </div>
    {% endif %}

    <hr class = "">
    <!-- Session List -->
    {% if sessions %}
    <div class="overflow-x-auto">
      <table class="min-w-full border border-gray-200 rounded-lg overflow-hidden">
        <thead class="bg-[#f9fafa]">
          <tr class = "text-gray-700 font-semibold">
            <th class="text-left p-2 px-5">Date</th>
            <th class="text-left p-2">Schedule</th>
            <th class="text-left p-2">Status</th>
            <th class="text-left p-2">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for session in sessions %}
          <tr class="border-t hover:bg-gray-50 transition">
            <td class="p-2 px-5">{{ session.date|date:"M d, Y" }}</td>
            <td class="p-2"><i class="fa-regular fa-clock pr-2"></i>{{ session.schedule_day.day_of_week }} — {{ session.schedule_day.start_time|time:"h:i A" }} to {{ session.schedule_day.end_time|time:"h:i A" }}</td>
            <td class="p-2">
              <span
                class="px-3 py-1 rounded-lg border font-semibold text-sm {% if session.status == 'ongoing' %}bg-yellow-100 border-amber-400 text-yellow-500{% elif session.status == 'completed' %}border-green-400 text-[#166534] bg-[#DCFCE7] {% else %}bg-gray-400{% endif %}">
                {{ session.status|capfirst }}
              </span>
            </td>
            <td class="p-2 flex items-center justify-start space-x-2"> 
                <a href="{% url 'dashboard_teacher:view_session' class_obj.id session.id %}" 
                    class="
                        bg-[#F8FAFC] border border-[#E2E8F0] 
                        hover:bg-[#e9f1ff] hover:text-blue-600 hover:border-blue-500 
                        w-8 h-8 flex items-center justify-center rounded transition">
                    <i class="fa-regular fa-eye"></i>
                </a>
                
                <button type="button"
                  data-url="{% url 'dashboard_teacher:delete_session' session.id %}"
                  data-session-id="{{ session.id }}"
                  data-session-label="{{ session.date|date:'M d, Y' }} — {{ session.schedule_day.day_of_week }}"
                  onclick="openRemoveSessionModal(this.dataset.sessionId, this.dataset.sessionLabel, this.dataset.url)"
                  class="
                    bg-[#F8FAFC] border border-[#E2E8F0] 
                    hover:bg-red-50 hover:text-red-600 hover:border-red-500
                    w-8 h-8 flex items-center justify-center rounded transition">
                  <i class="fa-regular fa-trash-can"></i>
                </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-gray-500 p-5 text-center">No sessions yet.</p>
    {% endif %}
  </div>

  <!-- Remove Student Modal -->
  <div id="removeModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6 text-center fade-in transition-all">
      <h2 class="text-lg font-semibold text-[#6a1e1e] mb-2">Confirm Removal</h2>
      <p class="text-gray-600 mb-4">
        Are you sure you want to remove
        <span id="studentName" class="font-medium text-[#a2314b]"></span> from this class?
      </p>
      <form id="removeForm" method="POST" class="flex justify-center gap-3">
        {% csrf_token %}
        <input type="hidden" name="remove_student" id="removeStudentId" />
        <button type="button" onclick="closeRemoveModal()" class="px-4 py-2 border border-[#E2E8F0] bg-[#F8FAFC] text-gray-600 rounded-md hover:bg-gray-100 transition-all">
          Cancel
        </button>
        <button type="submit" class="px-4 py-2 bg-[#8f2b43] hover:bg-[#a2314b]  text-white rounded-lg transition">
          Remove
        </button>
      </form>
    </div>
  </div>

  <!-- Remove Session Modal (matches Remove Student style) -->
  <div id="removeSessionModal" class="fixed inset-0 bg-black bg-opacity-40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6 text-center fade-in transition-all">
      <h2 class="text-lg font-semibold text-[#6a1e1e] mb-2">Confirm Delete</h2>
      <p class="text-gray-600 mb-4">
        Are you sure you want to delete the session on
        <span id="sessionName" class="font-medium text-[#a2314b]"></span>?
      </p>
      <form id="removeSessionForm" method="POST" class="flex justify-center gap-3">
        {% csrf_token %}
        <input type="hidden" name="remove_session" id="removeSessionId" />
        <button type="button" onclick="closeRemoveSessionModal()" class="px-4 py-2 border border-[#E2E8F0] bg-[#F8FAFC] text-gray-600 rounded-md hover:bg-gray-100 transition-all">
          Cancel
        </button>
        <button type="submit" class="px-4 py-2 bg-[#8f2b43] hover:bg-[#a2314b]  text-white rounded-lg transition">
          Delete
        </button>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const studentsTabBtn = document.getElementById("studentsTabBtn");
  const sessionsTabBtn = document.getElementById("sessionsTabBtn");
  const studentsTab = document.getElementById("studentsTab");
  const sessionsTab = document.getElementById("sessionsTab");

  function switchTab(showTab) {
    if (showTab === "students") {
      studentsTab.classList.remove("hidden");
      sessionsTab.classList.add("hidden");

      studentsTabBtn.classList.add("bg-[#8f2b43]", "text-white", "shadow-md");
      studentsTabBtn.classList.remove("bg-[#F8FAFC]", "text-gray-600", "border", "border-gray-400");

      sessionsTabBtn.classList.remove("bg-[#8f2b43]", "text-white", "shadow-md");
      sessionsTabBtn.classList.add("bg-[#F8FAFC]", "text-gray-600", "border", "border-gray-400");
    } else {
      studentsTab.classList.add("hidden");
      sessionsTab.classList.remove("hidden");

      sessionsTabBtn.classList.add("bg-[#8f2b43]", "text-white", "shadow-md");
      sessionsTabBtn.classList.remove("bg-[#F8FAFC]", "text-gray-600", "border", "border-gray-400");

      studentsTabBtn.classList.remove("bg-[#8f2b43]", "text-white", "shadow-md");
      studentsTabBtn.classList.add("bg-[#F8FAFC]", "text-gray-600", "border", "border-gray-400");
    }
  }

  // Event listeners
  studentsTabBtn.addEventListener("click", () => switchTab("students"));
  sessionsTabBtn.addEventListener("click", () => switchTab("sessions"));

  // Default tab
  switchTab("students");
  
    const addStudentSection = document.getElementById("addStudentSection");
    const addStudentButton = document.querySelector("#addStudentBtn");
    const cancelButton = addStudentSection.querySelector(".cancel-btn");

    const uploadCsvSection = document.getElementById("uploadCsvSection");
    const uploadCsvButton = document.querySelector("#uploadCsvBtn");
    const csvCancelButton = uploadCsvSection.querySelector(".csv-cancel-btn");

    // Hide by default
    addStudentSection.style.display = "none";
    uploadCsvSection.style.display = "none";

    // Function to hide both sections
    function hideBothSections() {
      addStudentSection.style.display = "none";
      uploadCsvSection.style.display = "none";
    }

    // Show add student section
    addStudentButton.addEventListener("click", (e) => {
      e.preventDefault();
      hideBothSections();
      addStudentSection.style.display = "block";
    });

    // Cancel add student hides section
    cancelButton.addEventListener("click", (e) => {
      e.preventDefault();
      addStudentSection.style.display = "none";
    });

    // Show upload CSV section
    uploadCsvButton.addEventListener("click", (e) => {
      e.preventDefault();
      hideBothSections();
      uploadCsvSection.style.display = "block";
    });

    // Cancel upload CSV hides section
    csvCancelButton.addEventListener("click", (e) => {
      e.preventDefault();
      uploadCsvSection.style.display = "none";
    });
  });

    function openRemoveModal(studentId, studentName) {
      document.getElementById("studentName").textContent = studentName;
      document.getElementById("removeStudentId").value = studentId;
      document.getElementById("removeModal").classList.remove("hidden");
      document.getElementById("removeModal").classList.add("flex");
    }

    function closeRemoveModal() {
      document.getElementById("removeModal").classList.add("hidden");
      document.getElementById("removeModal").classList.remove("flex");
    }

    function openRemoveSessionModal(sessionId, sessionLabel, actionUrl) {
      document.getElementById("sessionName").textContent = sessionLabel;
      document.getElementById("removeSessionId").value = sessionId;
      const form = document.getElementById("removeSessionForm");
      // set action to the provided delete URL
      if(actionUrl){
        form.action = actionUrl;
      }
      document.getElementById("removeSessionModal").classList.remove("hidden");
      document.getElementById("removeSessionModal").classList.add("flex");
    }

    function closeRemoveSessionModal() {
      document.getElementById("removeSessionModal").classList.add("hidden");
      document.getElementById("removeSessionModal").classList.remove("flex");
    }
  </script>
</div>
</div>
{% endblock %}